pipeline {
    agent any

    parameters {
        booleanParam(name: 'DESTROY_INFRASTRUCTURE', defaultValue: false, description: 'Destruir infraestructura existente')
        booleanParam(name: 'SKIP_ANSIBLE', defaultValue: false, description: 'Saltar configuraci√≥n de Ansible')
        booleanParam(name: 'AUTO_CLEANUP_ON_FAILURE', defaultValue: true, description: 'Destruir infraestructura autom√°ticamente si falla')
    }

    environment {
        // Credenciales de Azure (configurar en Jenkins)
        ARM_CLIENT_ID       = credentials('AZURE_CLIENT_ID')
        ARM_CLIENT_SECRET   = credentials('AZURE_CLIENT_SECRET')
        ARM_SUBSCRIPTION_ID = credentials('AZURE_SUBSCRIPTION_ID')
        ARM_TENANT_ID       = credentials('AZURE_TENANT_ID')
        
        // Directorios
        TF_DIR              = 'azure-jenkins-infrastructure/terraform'
        ANSIBLE_DIR         = 'azure-jenkins-infrastructure/ansible'
        SSH_KEY_FILE        = 'azure_jenkins_key'
        
        // Control de estado
        INFRASTRUCTURE_DEPLOYED = 'false'
    }

    stages {
        stage('Setup Terraform') {
            steps {
                script {
                    try {
                        // Siempre instalar Terraform (patr√≥n del Jenkinsfile principal)
                        sh '''
                            echo "Instalando Terraform en directorio temporal..."
                            
                            # Crear directorio temporal para Terraform
                            mkdir -p /tmp/terraform-${BUILD_NUMBER}
                            cd /tmp/terraform-${BUILD_NUMBER}
                            
                            # Descargar e instalar Terraform usando curl
                            echo "Descargando Terraform 1.6.0..."
                            curl -fsSL -o terraform.zip https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
                            
                            echo "Extrayendo Terraform..."
                            if command -v unzip &> /dev/null; then
                                unzip -o -q terraform.zip
                            else
                                # Alternativa si unzip no est√° disponible
                                python3 -c "
import zipfile
with zipfile.ZipFile('terraform.zip', 'r') as zip_ref:
    zip_ref.extractall('.')
"
                            fi
                            chmod +x terraform
                            
                            # Verificar instalaci√≥n
                            echo "‚úÖ Terraform instalado correctamente:"
                            ./terraform version
                        '''
                    } catch (Exception e) {
                        error("‚ùå Error instalando Terraform: ${e.getMessage()}")
                    }
                }
            }
        }

        stage('Destroy Infrastructure') {
            when {
                expression { params.DESTROY_INFRASTRUCTURE == true }
            }
            steps {
                script {
                    try {
                        dir("${TF_DIR}") {
                            sh '''
                                # Usar Terraform desde la ubicaci√≥n temporal o sistema
                                if [ -f "/tmp/terraform-${BUILD_NUMBER}/terraform" ]; then
                                    TERRAFORM_BIN="/tmp/terraform-${BUILD_NUMBER}/terraform"
                                else
                                    TERRAFORM_BIN="terraform"
                                fi
                                
                                echo "üî• Destruyendo infraestructura..."
                                $TERRAFORM_BIN init
                                $TERRAFORM_BIN destroy -auto-approve
                                echo "‚úÖ Infraestructura destruida exitosamente"
                            '''
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Error destruyendo infraestructura: ${e.getMessage()}"
                        // No fallar aqu√≠, continuar
                    }
                }
            }
        }

        stage('Deploy Infrastructure') {
            steps {
                script {
                    try {
                        dir("${TF_DIR}") {
                            sh '''
                                # Usar Terraform desde la ubicaci√≥n temporal o sistema
                                if [ -f "/tmp/terraform-${BUILD_NUMBER}/terraform" ]; then
                                    TERRAFORM_BIN="/tmp/terraform-${BUILD_NUMBER}/terraform"
                                else
                                    TERRAFORM_BIN="terraform"
                                fi
                                
                                echo "üöÄ Desplegando infraestructura en Azure..."
                                echo "üîë Terraform generar√° claves SSH autom√°ticamente"
                                
                                # Inicializar Terraform
                                $TERRAFORM_BIN init
                                
                                # Planificar
                                $TERRAFORM_BIN plan -out=tfplan
                                
                                # Aplicar
                                $TERRAFORM_BIN apply -auto-approve tfplan
                                
                                # Mostrar outputs (sin secretos)
                                echo "üìä Informaci√≥n de la infraestructura:"
                                $TERRAFORM_BIN output master_public_ip
                                $TERRAFORM_BIN output jenkins_url
                                
                                # Guardar clave SSH privada para uso posterior
                                echo "üîê Guardando clave SSH generada autom√°ticamente..."
                                $TERRAFORM_BIN output -raw ssh_private_key > ../${SSH_KEY_FILE}
                                chmod 600 ../${SSH_KEY_FILE}
                                # Copiarla dentro del directorio ansible para que ansible.cfg la detecte
                                cp ../${SSH_KEY_FILE} ../ansible/${SSH_KEY_FILE}
                            '''
                            
                            // Marcar que la infraestructura fue desplegada
                            env.INFRASTRUCTURE_DEPLOYED = 'true'
                            echo "‚úÖ Infraestructura desplegada exitosamente"
                        }
                    } catch (Exception e) {
                        env.INFRASTRUCTURE_DEPLOYED = 'true' // Marcar para limpieza
                        error("‚ùå Error desplegando infraestructura: ${e.getMessage()}")
                    }
                }
            }
        }

        stage('Wait for VMs') {
            steps {
                script {
                    try {
                        // Obtener IPs de Terraform
                        dir("${TF_DIR}") {
                            env.MASTER_IP = sh(
                                script: '''
                                    if [ -f "/tmp/terraform-${BUILD_NUMBER}/terraform" ]; then
                                        TERRAFORM_BIN="/tmp/terraform-${BUILD_NUMBER}/terraform"
                                    else
                                        TERRAFORM_BIN="terraform"
                                    fi
                                    $TERRAFORM_BIN output -raw master_public_ip
                                ''',
                                returnStdout: true
                            ).trim()
                            
                            env.SLAVE_IP = sh(
                                script: '''
                                    if [ -f "/tmp/terraform-${BUILD_NUMBER}/terraform" ]; then
                                        TERRAFORM_BIN="/tmp/terraform-${BUILD_NUMBER}/terraform"
                                    else
                                        TERRAFORM_BIN="terraform"
                                    fi
                                    $TERRAFORM_BIN output -raw slave_private_ip
                                ''',
                                returnStdout: true
                            ).trim()
                        }
                        
                        echo "Master IP: ${env.MASTER_IP}"
                        echo "Slave IP: ${env.SLAVE_IP}"
                        
                        // Esperar a que las VMs est√©n listas
                        sh '''
                            echo "‚è≥ Esperando a que las VMs est√©n listas..."
                            for i in {1..10}; do
                                if ssh -i ${SSH_KEY_FILE} -o ConnectTimeout=5 -o StrictHostKeyChecking=no azureuser@$MASTER_IP "echo 'VM Ready'" 2>/dev/null; then
                                    echo "‚úÖ Master VM est√° lista"
                                    break
                                fi
                                echo "Intento $i/10 - Esperando 30 segundos..."
                                sleep 30
                            done
                        '''

                        // Esperar a que el Slave est√© listo
                        sh '''
                            echo "‚è≥ Esperando a que la VM Slave est√© lista..."
                            for i in {1..20}; do
                                if ssh -i ${SSH_KEY_FILE} -o ProxyJump=azureuser@$MASTER_IP -o ConnectTimeout=10 -o StrictHostKeyChecking=no azureuser@$SLAVE_IP "echo 'VM Ready'" 2>/dev/null; then
                                    echo "‚úÖ Slave VM est√° lista"
                                    break
                                fi
                                echo "Intento $i/20 - Esperando 30 segundos..."
                                sleep 30
                            done
                        '''
                    } catch (Exception e) {
                        error("‚ùå Error esperando VMs: ${e.getMessage()}")
                    }
                }
            }
        }

        stage('Configure Ansible Inventory') {
            when {
                expression { params.SKIP_ANSIBLE == false }
            }
            steps {
                script {
                    try {
                        dir("${ANSIBLE_DIR}") {
                            sh '''
                                echo "üìù Configurando inventario de Ansible..."
                                
                                # Crear copia del inventario para no modificar el original
                                cp inventory/hosts inventory/hosts.tmp
                                
                                # Actualizar inventario con IPs reales
                                sed -i "s/MASTER_IP/$MASTER_IP/g" inventory/hosts.tmp
                                sed -i "s/SLAVE_IP/$SLAVE_IP/g" inventory/hosts.tmp
                                
                                # Usar el inventario temporal
                                mv inventory/hosts.tmp inventory/hosts
                                
                                echo "Inventario configurado:"
                                cat inventory/hosts
                            '''
                        }
                    } catch (Exception e) {
                        error("‚ùå Error configurando Ansible: ${e.getMessage()}")
                    }
                }
            }
        }

        stage('Install Jenkins') {
            when {
                expression { params.SKIP_ANSIBLE == false }
            }
            steps {
                script {
                    try {
                        dir("${ANSIBLE_DIR}") {
                            sh '''
                                echo "üîß Instalando Jenkins con Ansible..."
                                
                                # Crear entorno virtual aislado para Ansible (evita PEP 668)
                                echo "Creando entorno virtual para Ansible..."
                                python3 -m venv /tmp/ansible-venv-${BUILD_NUMBER}
                                . /tmp/ansible-venv-${BUILD_NUMBER}/bin/activate
                                
                                # Instalar/actualizar pip y ansible en el venv
                                pip install --upgrade pip
                                pip install ansible==9.1.0
                                
                                # Verificar instalaci√≥n
                                echo "‚úÖ Ansible instalado en entorno virtual:" && ansible-playbook --version
                                
                                # Ejecutar playbook usando el ansible del venv
                                ANSIBLE_BIN=/tmp/ansible-venv-${BUILD_NUMBER}/bin/ansible-playbook
                                $ANSIBLE_BIN -i inventory/hosts playbooks/install-jenkins.yml -v
                            '''
                        }
                    } catch (Exception e) {
                        error("‚ùå Error instalando Jenkins: ${e.getMessage()}")
                    }
                }
            }
        }

        stage('Display Results') {
            steps {
                script {
                    try {
                        dir("${TF_DIR}") {
                            def jenkinsUrl = sh(
                                script: '''
                                    if [ -f "/tmp/terraform-${BUILD_NUMBER}/terraform" ]; then
                                        TERRAFORM_BIN="/tmp/terraform-${BUILD_NUMBER}/terraform"
                                    else
                                        TERRAFORM_BIN="terraform"
                                    fi
                                    $TERRAFORM_BIN output -raw jenkins_url
                                ''',
                                returnStdout: true
                            ).trim()
                            
                            echo """
                            üéâ ¬°Despliegue completado exitosamente!
                            
                            üìä Informaci√≥n de acceso:
                            - Jenkins URL: ${jenkinsUrl}
                            - Master IP: ${env.MASTER_IP}
                            - Slave IP: ${env.SLAVE_IP}
                            
                            üîê Para acceder por SSH:
                            1. La clave SSH se gener√≥ autom√°ticamente y est√° en: ${env.SSH_KEY_FILE}
                            2. SSH al Master: ssh -i ${env.SSH_KEY_FILE} azureuser@${env.MASTER_IP}
                            3. Obtener password inicial: sudo cat /var/lib/jenkins/secrets/initialAdminPassword
                            4. Acceder a Jenkins: ${jenkinsUrl}
                            
                            üìù Configurar Slave en Jenkins:
                            1. Ve a Manage Jenkins > Manage Nodes
                            2. Agrega nuevo nodo con IP: ${env.SLAVE_IP}
                            3. Usa SSH como m√©todo de conexi√≥n
                            4. La misma clave SSH funciona para ambas VMs
                            """
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Error mostrando resultados: ${e.getMessage()}"
                    }
                }
            }
        }
    }

    post {
        always {
            script {
                echo "üßπ Iniciando limpieza de archivos temporales..."
                
                // Limpiar archivos temporales sensibles SIEMPRE
                sh '''
                    echo "Limpiando inventario temporal de Ansible..."
                    cd ${WORKSPACE}/${ANSIBLE_DIR}
                    if [ -f inventory/hosts.tmp ]; then
                        rm -f inventory/hosts.tmp
                    fi
                    
                    # Restaurar inventario original si existe backup
                    if [ -f inventory/hosts.original ]; then
                        cp inventory/hosts.original inventory/hosts
                    fi
                '''
            }
            echo "‚úÖ Pipeline completado - archivos temporales limpiados"
        }
        
        failure {
            script {
                echo "‚ùå Pipeline fall√≥ - Iniciando limpieza autom√°tica..."
                
                if (env.INFRASTRUCTURE_DEPLOYED == 'true' && params.AUTO_CLEANUP_ON_FAILURE) {
                    echo "üî• Ejecutando terraform destroy autom√°tico..."
                    
                    try {
                        dir("${TF_DIR}") {
                            sh '''
                                # Usar Terraform desde la ubicaci√≥n temporal o sistema
                                if [ -f "/tmp/terraform-${BUILD_NUMBER}/terraform" ]; then
                                    TERRAFORM_BIN="/tmp/terraform-${BUILD_NUMBER}/terraform"
                                else
                                    TERRAFORM_BIN="terraform"
                                fi
                                
                                echo "Destruyendo infraestructura debido a fallo..."
                                $TERRAFORM_BIN init
                                $TERRAFORM_BIN destroy -auto-approve
                                echo "‚úÖ Infraestructura destruida autom√°ticamente"
                            '''
                        }
                    } catch (Exception e) {
                        echo "‚ö†Ô∏è Error durante limpieza autom√°tica: ${e.getMessage()}"
                        echo "üö® ACCI√ìN REQUERIDA: Destruir infraestructura manualmente en Azure"
                    }
                } else if (env.INFRASTRUCTURE_DEPLOYED == 'true') {
                    echo "‚ö†Ô∏è AUTO_CLEANUP_ON_FAILURE est√° deshabilitado"
                    echo "üö® ACCI√ìN REQUERIDA: Ejecutar pipeline con DESTROY_INFRASTRUCTURE=true"
                }
                
                // Limpiar clave SSH en caso de fallo
                sh '''
                    if [ -f ${SSH_KEY_FILE} ]; then
                        echo "Limpiando clave SSH temporal..."
                        rm -f ${SSH_KEY_FILE}
                    fi
                '''
                
                echo """
                ‚ùå PIPELINE FALL√ì
                
                üîç Pasos para debug:
                1. Revisar logs del stage que fall√≥
                2. Verificar credenciales en Jenkins (solo Azure, no SSH)
                3. Verificar conectividad a Azure
                4. Si infraestructura qued√≥ parcial, ejecutar con DESTROY_INFRASTRUCTURE=true
                
                üìû Soporte: Crear issue en GitHub con logs completos
                """
            }
        }
        
        success {
            echo """
            ‚úÖ PIPELINE EXITOSO
            
            üéØ Pr√≥ximos pasos:
            1. Acceder a Jenkins en la URL mostrada
            2. Configurar el slave desde la UI usando la misma clave SSH
            3. Crear jobs para tu proyecto AWS existente
            4. ¬°Disfrutar tu Jenkins en la nube con claves autom√°ticas!
            
            üîë Ventajas de las claves autom√°ticas:
            - Generadas autom√°ticamente por Azure/Terraform
            - √önicas para cada despliegue
            - No necesitas manejar claves manualmente
            """
        }
    }
} 